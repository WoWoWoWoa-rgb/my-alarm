<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ã‚¢ãƒ©ãƒ¼ãƒ </title>
</head>
<body>
  <h1>â° ã‚¢ãƒ©ãƒ¼ãƒ ã‚’ã‚»ãƒƒãƒˆ</h1>

  <label>æ™‚ï¼ˆ0ã€œ23ï¼‰: <input type="number" id="hour" min="0" max="23"></label><br>
  <label>åˆ†ï¼ˆ0ã€œ59ï¼‰: <input type="number" id="minute" min="0" max="59"></label><br>
  <label>ç§’ï¼ˆ0ã€œ59ï¼‰: <input type="number" id="second" min="0" max="59"></label><br><br>

  <button onclick="testAudio()">ğŸ”Š éŸ³ã®ãƒ†ã‚¹ãƒˆï¼ˆå¿…ãšå…ˆã«æŠ¼ã—ã¦ãã ã•ã„ï¼‰</button><br><br>
  <button onclick="setAlarm()">âœ… ã‚¢ãƒ©ãƒ¼ãƒ ã‚’é–‹å§‹</button>

  <p id="status">å¾…æ©Ÿä¸­...</p>

  <!-- éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ« -->
  <audio id="alarmSound" src="./OldManRiver.mp3" preload="auto" controls></audio>

  <script>
    let alarmTime = null;
    let alarmIntervalId = null;  // setIntervalã®IDã‚’ä¿å­˜

    // éŸ³ã®å†ç”Ÿãƒ†ã‚¹ãƒˆç”¨ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã§å†ç”Ÿè¨±å¯ã‚’å¾—ã‚‹ï¼‰
    function testAudio() {
      const audio = document.getElementById("alarmSound");
      audio.play().then(() => {
        audio.pause();
        audio.currentTime = 0;
        alert("ğŸ”Š éŸ³å£°ã®å†ç”ŸãŒè¨±å¯ã•ã‚Œã¾ã—ãŸã€‚æ¬¡ã«ã‚¢ãƒ©ãƒ¼ãƒ ã‚’ã‚»ãƒƒãƒˆã—ã¦ãã ã•ã„ã€‚");
      }).catch((e) => {
        alert("âš ï¸ éŸ³å£°å†ç”ŸãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚");
        console.warn("éŸ³å£°å†ç”Ÿãƒ–ãƒ­ãƒƒã‚¯ï¼š", e);
      });
    }

    function setAlarm() {
      // å…¥åŠ›å€¤ã®å–å¾—ï¼†æ•°å€¤åŒ–
      const hour = parseInt(document.getElementById("hour").value, 10);
      const minute = parseInt(document.getElementById("minute").value, 10);
      const second = parseInt(document.getElementById("second").value, 10);

      // å…¥åŠ›å€¤ãƒã‚§ãƒƒã‚¯
      if (
        isNaN(hour) || hour < 0 || hour > 23 ||
        isNaN(minute) || minute < 0 || minute > 59 ||
        isNaN(second) || second < 0 || second > 59
      ) {
        alert("æ­£ã—ã„æ™‚ãƒ»åˆ†ãƒ»ç§’ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      const now = new Date();
      alarmTime = new Date();
      alarmTime.setHours(hour);
      alarmTime.setMinutes(minute);
      alarmTime.setSeconds(second);
      alarmTime.setMilliseconds(0);

      // ã‚¢ãƒ©ãƒ¼ãƒ æ™‚é–“ãŒéå»ãªã‚‰ç¿Œæ—¥ã«è¨­å®š
      if (alarmTime <= now) {
        alarmTime.setDate(alarmTime.getDate() + 1);
      }

      document.getElementById("status").innerText = `ğŸ•’ ã‚¢ãƒ©ãƒ¼ãƒ ã‚’ ${alarmTime.toLocaleTimeString()} ã«ã‚»ãƒƒãƒˆã—ã¾ã—ãŸ`;

      // æ—¢ã«intervalãŒã‚ã‚Œã°ã‚¯ãƒªã‚¢ï¼ˆå¤šé‡èµ·å‹•é˜²æ­¢ï¼‰
      if (alarmIntervalId !== null) {
        clearInterval(alarmIntervalId);
      }

      // ã‚¢ãƒ©ãƒ¼ãƒ ãƒã‚§ãƒƒã‚¯é–‹å§‹ï¼ˆ500msã”ã¨ï¼‰
      alarmIntervalId = setInterval(() => {
        const now = new Date();
        if (now >= alarmTime) {
          clearInterval(alarmIntervalId);
          alarmIntervalId = null;
          document.getElementById("status").innerText = "â° ã‚¢ãƒ©ãƒ¼ãƒ ç™ºå‹•ï¼";
          const audio = document.getElementById("alarmSound");
          audio.currentTime = 0;
          audio.play().catch(e => {
            document.getElementById("status").innerText = "âš ï¸ éŸ³å£°ãŒå†ç”Ÿã§ãã¾ã›ã‚“ã§ã—ãŸ";
            console.error(e);
          });
        }
      }, 500);
    }
  </script>
</body>
</html>
