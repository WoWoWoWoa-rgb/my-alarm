<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>アラーム</title>
</head>
<body>
  <h1>⏰ アラームをセット</h1>

  <label>何時間後: <input type="number" id="hour" min="0" value="0"></label><br>
  <label>何分後: <input type="number" id="minute" min="0" value="0"></label><br>
  <label>何秒後: <input type="number" id="second" min="0" value="0"></label><br><br>

  <button onclick="setAlarm()">✅ アラームを開始</button>
  <button id="stopButton" onclick="stopAlarm()" style="display:none;">🛑 アラームを止める</button>

  <p id="status">待機中...</p>

  <audio id="alarmSound" src="./02 - Old Man River.mp3" preload="auto" loop></audio>

  <script>
    let alarmTimeout = null;
    let isAudioAllowed = false;

    function setAlarm() {
      const hours = parseInt(document.getElementById("hour").value) || 0;
      const minutes = parseInt(document.getElementById("minute").value) || 0;
      const seconds = parseInt(document.getElementById("second").value) || 0;

      const totalMs = (hours * 3600 + minutes * 60 + seconds) * 1000;

      if (totalMs <= 0) {
        alert("⏳ 1秒以上の時間を設定してください。");
        return;
      }

      const audio = document.getElementById("alarmSound");

      // 初回の再生許可をここで試みる（自動許可を得る）
      audio.play().then(() => {
        audio.pause();
        audio.currentTime = 0;
        isAudioAllowed = true;
      }).catch((e) => {
        console.warn("自動再生はまだ許可されていません。ユーザー操作を待ちます。");
      });

      document.getElementById("status").innerText =
        `⏳ アラームを ${hours}時間${minutes}分${seconds}秒後にセットしました。`;

      // アラームを予約
      alarmTimeout = setTimeout(() => {
        document.getElementById("status").innerText = "⏰ アラーム発動！";
        audio.play().catch(e => {
          document.getElementById("status").innerText = "⚠️ 音声が再生できませんでした";
          console.error(e);
        });
        document.getElementById("stopButton").style.display = "inline-block";
      }, totalMs);
    }

    function stopAlarm() {
      const audio = document.getElementById("alarmSound");
      audio.pause();
      audio.currentTime = 0;
      document.getElementById("status").innerText = "✅ アラーム停止中";
      document.getElementById("stopButton").style.display = "none";
      clearTimeout(alarmTimeout);
    }
  </script>
</body>
</html>
