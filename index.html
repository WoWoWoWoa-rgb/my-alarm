<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>アラーム</title>
</head>
<body>
  <h1>⏰ アラームをセット</h1>

  <label>時（0〜23）: <input type="number" id="hour" min="0" max="23"></label><br>
  <label>分（0〜59）: <input type="number" id="minute" min="0" max="59"></label><br>
  <label>秒（0〜59）: <input type="number" id="second" min="0" max="59"></label><br><br>

  <button onclick="testAudio()">🔊 音のテスト（必ず先に押してください）</button><br><br>
  <button onclick="setAlarm()">✅ アラームを開始</button>

  <p id="status">待機中...</p>

  <!-- 音声ファイル -->
  <audio id="alarmSound" src="./OldManRiver.mp3" preload="auto" controls></audio>

  <script>
    let alarmTime = null;
    let alarmIntervalId = null;  // setIntervalのIDを保存

    // 音の再生テスト用（ユーザー操作で再生許可を得る）
    function testAudio() {
      const audio = document.getElementById("alarmSound");
      audio.play().then(() => {
        audio.pause();
        audio.currentTime = 0;
        alert("🔊 音声の再生が許可されました。次にアラームをセットしてください。");
      }).catch((e) => {
        alert("⚠️ 音声再生がブロックされました。もう一度ボタンを押してください。");
        console.warn("音声再生ブロック：", e);
      });
    }

    function setAlarm() {
      // 入力値の取得＆数値化
      const hour = parseInt(document.getElementById("hour").value, 10);
      const minute = parseInt(document.getElementById("minute").value, 10);
      const second = parseInt(document.getElementById("second").value, 10);

      // 入力値チェック
      if (
        isNaN(hour) || hour < 0 || hour > 23 ||
        isNaN(minute) || minute < 0 || minute > 59 ||
        isNaN(second) || second < 0 || second > 59
      ) {
        alert("正しい時・分・秒を入力してください。");
        return;
      }

      const now = new Date();
      alarmTime = new Date();
      alarmTime.setHours(hour);
      alarmTime.setMinutes(minute);
      alarmTime.setSeconds(second);
      alarmTime.setMilliseconds(0);

      // アラーム時間が過去なら翌日に設定
      if (alarmTime <= now) {
        alarmTime.setDate(alarmTime.getDate() + 1);
      }

      document.getElementById("status").innerText = `🕒 アラームを ${alarmTime.toLocaleTimeString()} にセットしました`;

      // 既にintervalがあればクリア（多重起動防止）
      if (alarmIntervalId !== null) {
        clearInterval(alarmIntervalId);
      }

      // アラームチェック開始（500msごと）
      alarmIntervalId = setInterval(() => {
        const now = new Date();
        if (now >= alarmTime) {
          clearInterval(alarmIntervalId);
          alarmIntervalId = null;
          document.getElementById("status").innerText = "⏰ アラーム発動！";
          const audio = document.getElementById("alarmSound");
          audio.currentTime = 0;
          audio.play().catch(e => {
            document.getElementById("status").innerText = "⚠️ 音声が再生できませんでした";
            console.error(e);
          });
        }
      }, 500);
    }
  </script>
</body>
</html>
